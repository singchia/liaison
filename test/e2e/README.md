# Liaison E2E Tests

这个目录包含了Liaison项目的端到端（E2E）测试。

## 测试结构

- `iam_test.go` - 完整的IAM功能测试（需要默认用户）
- `simple_test.go` - 简化的基础功能测试
- `run_simple_test.sh` - 简化测试运行脚本
- `run_e2e_test.sh` - 完整测试运行脚本
- `test_config.yaml` - 测试配置文件

## 快速开始

### 运行简化测试

简化测试只验证基础功能，不需要创建默认用户：

```bash
# 运行简化测试
./test/e2e/run_simple_test.sh
```

这个测试会：
1. 构建项目
2. 启动服务器
3. 测试健康检查端点
4. 测试IAM端点（登录/登出不需要认证）
5. 测试受保护端点需要认证
6. 停止服务器

### 运行完整测试

完整测试需要创建默认用户：

```bash
# 运行完整测试
./test/e2e/run_e2e_test.sh
```

## 测试内容

### 简化测试 (simple_test.go)

1. **健康检查测试**
   - 验证 `/health` 端点返回正常状态

2. **IAM端点测试**
   - 验证 `/v1/iam/login` 不需要认证
   - 验证 `/v1/iam/logout` 不需要认证

3. **受保护端点测试**
   - 验证 `/v1/applications` 需要认证
   - 验证 `/v1/iam/profile` 需要认证

### 完整测试 (iam_test.go)

1. **用户登录测试**
   - 有效凭据登录
   - 无效凭据登录

2. **用户信息获取测试**
   - 有效token获取用户信息
   - 无token访问用户信息
   - 无效token访问用户信息

3. **认证中间件测试**
   - 受保护端点需要有效token
   - 受保护端点拒绝无token访问
   - 登录端点不需要认证

4. **用户登出测试**
   - 有效token登出

## 测试环境

测试使用独立的SQLite数据库 (`test_liaison.db`)，不会影响生产数据。

## 依赖

- Go 1.23+
- Docker (用于protobuf生成)
- curl (用于健康检查)

## 故障排除

### 服务器启动失败

如果服务器启动失败，检查：
1. 端口8080是否被占用
2. 配置文件是否正确
3. 数据库权限是否正确

### 测试失败

如果测试失败，检查：
1. 服务器是否正常运行
2. 网络连接是否正常
3. 测试依赖是否正确安装

## 开发说明

### 添加新测试

1. 在相应的测试文件中添加新的测试函数
2. 使用 `t.Run()` 创建子测试
3. 使用 `assert` 和 `require` 进行断言

### 修改测试配置

编辑 `test_config.yaml` 文件来修改测试配置。

### 调试测试

使用 `-v` 标志运行测试以获取详细输出：

```bash
go test -v ./test/e2e/
```
